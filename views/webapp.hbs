<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Bitrix Monitor</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, var(--tg-theme-bg-color, #f5f7fa) 0%, var(--tg-theme-secondary-bg-color, #e8ecf1) 100%);
            color: var(--tg-theme-text-color, #1a1a1a);
            padding: 0;
            min-height: 100vh;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* –£–ª—É—á—à–µ–Ω–Ω–∞—è –∫–æ–Ω—Ç—Ä–∞—Å—Ç–Ω–æ—Å—Ç—å –¥–ª—è —Ç–µ–º–Ω–æ–π —Ç–µ–º—ã */
        @media (prefers-color-scheme: dark) {
            body {
                background: linear-gradient(135deg, var(--tg-theme-bg-color, #0e0e0d) 0%, var(--tg-theme-secondary-bg-color, #1a1a1a) 100%);
                color: #f5f5f5;
            }
        }

        .container {
            max-width: 100%;
            padding: 16px;
            position: relative;
        }

        /* –û—Ç—Å—Ç—É–ø —Å–Ω–∏–∑—É —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å –≤–∫–ª–∞–¥–∫–∏ (–¥–ª—è –∞–¥–º–∏–Ω–æ–≤) */
        body:has(.tabs) .container {
            padding-bottom: 100px;
        }

        .tabs {
            position: fixed;
            bottom: 16px;
            left: 16px;
            right: 16px;
            display: flex;
            gap: 8px;
            background: rgba(255, 255, 255, 0.98);
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 20px;
            padding: 8px;
            padding-bottom: max(8px, calc(8px + env(safe-area-inset-bottom)));
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15), 0 2px 8px rgba(0, 0, 0, 0.1);
            z-index: 10000;
            backdrop-filter: blur(2px) saturate(105%);
            -webkit-backdrop-filter: blur(2px) saturate(105%);
            will-change: transform;
            opacity: 0;
            transform: translateY(calc(100% + 32px));
            animation: slideUpFromBottom 0.5s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }

        .tabs::before {
            content: '';
            position: absolute;
            top: 8px;
            bottom: 8px;
            left: 8px;
            width: calc(50% - 12px);
            background: linear-gradient(135deg, rgba(51, 144, 236, 0.15) 0%, rgba(51, 144, 236, 0.1) 100%);
            border-radius: 14px;
            transition: left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 0;
            pointer-events: none;
        }

        .tabs.tab-phrases-active::before {
            left: calc(50% + 4px);
            width: calc(50% - 12px);
        }

        @media (prefers-color-scheme: dark) {
            .tabs {
                background: rgba(26, 26, 26, 0.98);
                border-color: rgba(255, 255, 255, 0.15);
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6), 0 2px 8px rgba(0, 0, 0, 0.4);
            }

            .tabs::before {
                background: linear-gradient(135deg, rgba(51, 144, 236, 0.25) 0%, rgba(51, 144, 236, 0.15) 100%);
            }
        }

        .tab {
            flex: 1;
            padding: 14px 20px;
            background: transparent;
            border: none;
            color: var(--tg-theme-hint-color, #6c757d);
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            border-radius: 14px;
            transition: color 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            -webkit-tap-highlight-color: transparent;
            outline: none;
            -webkit-touch-callout: none;
            user-select: none;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            z-index: 1;
        }

        .tab:active {
            transform: scale(0.95);
        }

        .tab.active {
            color: var(--tg-theme-button-color, #3390ec);
        }

        .tab:focus {
            outline: none;
        }

        .tab-content {
            display: none;
            padding-bottom: 20px;
            opacity: 0;
            transform: translateX(20px);
            transition: opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1), transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .tab-content.active {
            display: block;
            opacity: 1;
            transform: translateX(0);
        }

        .tab-content.animating {
            animation: slideIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(20px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes slideUpFromBottom {
            0% {
                opacity: 0;
                transform: translateY(calc(100% + 32px));
            }

            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes shake {

            0%,
            100% {
                transform: translateX(0);
            }

            20% {
                transform: translateX(-2px);
            }

            40% {
                transform: translateX(2px);
            }

            60% {
                transform: translateX(-2px);
            }

            80% {
                transform: translateX(2px);
            }
        }

        .tab-content.shaking {
            animation: shake 0.8s cubic-bezier(0.36, 0.07, 0.19, 0.97);
        }

        .status-card {
            background: var(--tg-theme-secondary-bg-color, #ffffff);
            border-radius: 20px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08), 0 1px 3px rgba(0, 0, 0, 0.05);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid rgba(0, 0, 0, 0.05);
            position: relative;
            overflow: hidden;
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }

        .status-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, transparent, rgba(51, 144, 236, 0.3), transparent);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .status-card:hover::before {
            opacity: 1;
        }

        @media (prefers-color-scheme: dark) {
            .status-card {
                background: var(--tg-theme-secondary-bg-color, #1a1a1a);
                border-color: rgba(255, 255, 255, 0.1);
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4), 0 1px 3px rgba(0, 0, 0, 0.2);
            }
        }

        .status-card:active {
            transform: scale(0.97);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .status-card:focus {
            outline: none;
        }

        .status-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .status-title {
            font-weight: bold;
            font-size: 16px;
            color: var(--tg-theme-text-color, #000000);
        }

        @media (prefers-color-scheme: dark) {
            .status-title {
                color: #f5f5f5;
            }
        }

        .status-badge {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-ok {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: #ffffff;
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
        }

        .status-error {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: #ffffff;
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
        }

        .status-warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: #ffffff;
            box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);
        }

        .status-details {
            font-size: 14px;
            color: var(--tg-theme-hint-color, #999999);
            margin-top: 8px;
            line-height: 1.5;
        }

        /* –£–ª—É—á—à–µ–Ω–Ω–∞—è —á–∏—Ç–∞–µ–º–æ—Å—Ç—å –¥–ª—è —Ç–µ–º–Ω–æ–π —Ç–µ–º—ã */
        .status-details {
            color: var(--tg-theme-hint-color, #999999);
        }

        @media (prefers-color-scheme: dark) {
            .status-details {
                color: #b0b0b0;
            }

            .status-details div[style*="border-top"] {
                border-top-color: rgba(255, 255, 255, 0.1) !important;
            }

            .status-details div[style*="background: rgba(0,0,0,0.1)"] {
                background: rgba(255, 255, 255, 0.1) !important;
            }
        }

        .phrase-item {
            background: var(--tg-theme-secondary-bg-color, #ffffff);
            border-radius: 16px;
            padding: 18px 20px;
            margin-bottom: 14px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 3px 12px rgba(0, 0, 0, 0.08), 0 1px 3px rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(0, 0, 0, 0.05);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .phrase-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: linear-gradient(180deg, var(--tg-theme-button-color, #3390ec), #2563eb);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .phrase-item:hover::before {
            opacity: 1;
        }

        @media (prefers-color-scheme: dark) {
            .phrase-item {
                background: var(--tg-theme-secondary-bg-color, #1a1a1a);
                border-color: rgba(255, 255, 255, 0.1);
                box-shadow: 0 3px 12px rgba(0, 0, 0, 0.3), 0 1px 3px rgba(0, 0, 0, 0.2);
            }
        }

        .phrase-item:active {
            transform: scale(0.97);
            box-shadow: 0 1px 6px rgba(0, 0, 0, 0.1);
        }

        .phrase-text {
            flex: 1;
            margin-right: 10px;
            color: var(--tg-theme-text-color, #000000);
            font-weight: 500;
        }

        @media (prefers-color-scheme: dark) {
            .phrase-text {
                color: #f5f5f5;
            }
        }

        .btn {
            padding: 10px 20px;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            -webkit-tap-highlight-color: transparent;
            outline: none;
            -webkit-touch-callout: none;
            user-select: none;
            position: relative;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: 10px;
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
        }

        .btn:active::before {
            opacity: 1;
        }

        .btn:focus {
            outline: none;
        }

        .btn::-moz-focus-inner {
            border: 0;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--tg-theme-button-color, #3390ec) 0%, #2563eb 100%);
            color: var(--tg-theme-button-text-color, #ffffff);
        }

        .btn-primary:active {
            transform: translateY(1px);
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.2);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }

        .btn-danger:active {
            transform: translateY(1px);
            box-shadow: 0 1px 4px rgba(239, 68, 68, 0.3);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-input {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid var(--tg-theme-hint-color, #e5e7eb);
            border-radius: 12px;
            font-size: 15px;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        @media (prefers-color-scheme: dark) {
            .form-input {
                border-color: rgba(255, 255, 255, 0.1);
                background: var(--tg-theme-bg-color, #0e0e0d);
            }
        }

        .form-input:focus {
            outline: none;
            border-color: var(--tg-theme-button-color, #3390ec);
            box-shadow: 0 0 0 3px rgba(51, 144, 236, 0.1);
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--tg-theme-hint-color, #999999);
        }
    </style>
</head>

<body>
    {{#if isAdmin}}
    <div class="tabs">
        <button class="tab active" onclick="switchTab('status')">üìä –°—Ç–∞—Ç—É—Å</button>
        <button class="tab" onclick="switchTab('phrases')">üìù –§—Ä–∞–∑—ã</button>
    </div>
    {{/if}}
    <div class="container">

        {{#if error}}
        <div id="error-message" style="padding: 20px; text-align: center; color: var(--tg-theme-hint-color, #999999);">
            <p style="color: #dc3545; font-weight: bold;">{{error}}</p>
            <p style="margin-top: 10px; font-size: 14px; color: var(--tg-theme-text-color, #000000);">–û—Ç–∫—Ä–æ–π—Ç–µ Web App
                —á–µ—Ä–µ–∑ Telegram –±–æ—Ç–∞</p>
            {{#if hasInitData}}
            <p style="margin-top: 10px; font-size: 12px; color: var(--tg-theme-hint-color, #666);">initData –ø–æ–ª—É—á–µ–Ω, –Ω–æ
                –≤–∞–ª–∏–¥–∞—Ü–∏—è –Ω–µ –ø—Ä–æ—à–ª–∞.
                –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞.</p>
            {{else}}
            <p style="margin-top: 10px; font-size: 12px; color: var(--tg-theme-hint-color, #666);">initData –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç.
                –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç–µ
                —á–µ—Ä–µ–∑ Telegram –±–æ—Ç–∞.</p>
            {{/if}}
        </div>
        {{else}}
        <div id="status-tab" class="tab-content active">
            {{#if serverStatus.database}}
            <div class="status-card" onclick="handleStatusCardClick(this)">
                <div class="status-header">
                    <span class="status-title">–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö</span>
                    <span class="status-badge status-{{serverStatus.database.status}}">
                        {{#if serverStatus.database.isOk}}‚úÖ{{/if}}
                        {{#if serverStatus.database.isError}}‚ùå{{/if}}
                        {{#if serverStatus.database.isWarning}}‚ö†Ô∏è{{/if}}
                    </span>
                </div>
                <div class="status-details">{{serverStatus.database.message}}</div>
            </div>
            {{/if}}

            {{#if serverStatus.telegram}}
            <div class="status-card" onclick="handleStatusCardClick(this)">
                <div class="status-header">
                    <span class="status-title">Telegram –±–æ—Ç</span>
                    <span class="status-badge status-{{serverStatus.telegram.status}}">
                        {{#if serverStatus.telegram.isOk}}‚úÖ{{/if}}
                        {{#if serverStatus.telegram.isError}}‚ùå{{/if}}
                        {{#if serverStatus.telegram.isWarning}}‚ö†Ô∏è{{/if}}
                    </span>
                </div>
                <div class="status-details">{{serverStatus.telegram.message}}</div>
            </div>
            {{/if}}

            {{#if serverStatus.bitrix}}
            <div class="status-card" onclick="handleStatusCardClick(this)">
                <div class="status-header">
                    <span class="status-title">Bitrix24 API</span>
                    <span class="status-badge status-{{serverStatus.bitrix.status}}">
                        {{#if serverStatus.bitrix.isOk}}‚úÖ{{/if}}
                        {{#if serverStatus.bitrix.isError}}‚ùå{{/if}}
                        {{#if serverStatus.bitrix.isWarning}}‚ö†Ô∏è{{/if}}
                    </span>
                </div>
                <div class="status-details">{{serverStatus.bitrix.message}}</div>
            </div>
            {{/if}}

            {{#if serverStatus.server}}
            <div class="status-card" onclick="handleStatusCardClick(this)">
                <div class="status-header">
                    <span class="status-title">–°–µ—Ä–≤–µ—Ä</span>
                    <span class="status-badge status-{{serverStatus.server.status}}">
                        {{#if serverStatus.server.isOk}}‚úÖ{{/if}}
                        {{#if serverStatus.server.isError}}‚ùå{{/if}}
                        {{#if serverStatus.server.isWarning}}‚ö†Ô∏è{{/if}}
                    </span>
                </div>
                <div class="status-details">
                    {{serverStatus.server.message}}
                    {{#if serverStatus.server.details.memory}}
                    <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(0,0,0,0.1);">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span>üíæ –ü–∞–º—è—Ç—å:</span>
                            <span style="font-weight: 600;">{{serverStatus.server.details.memory.used}} /
                                {{serverStatus.server.details.memory.total}}</span>
                        </div>
                        <div style="background: rgba(0,0,0,0.1); border-radius: 8px; height: 8px; overflow: hidden;">
                            <div
                                style="background: linear-gradient(90deg, #10b981, #059669); height: 100%; width: {{serverStatus.server.details.memory.usagePercent}}%; transition: width 0.3s;">
                            </div>
                        </div>
                    </div>
                    {{/if}}
                    {{#if serverStatus.server.details.cpu}}
                    <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(0,0,0,0.1);">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span>‚ö° CPU:</span>
                            <span style="font-weight: 600;">{{serverStatus.server.details.cpu.usagePercent}}%</span>
                        </div>
                        <div style="background: rgba(0,0,0,0.1); border-radius: 8px; height: 8px; overflow: hidden;">
                            <div
                                style="background: linear-gradient(90deg, #3b82f6, #2563eb); height: 100%; width: {{serverStatus.server.details.cpu.usagePercent}}%; transition: width 0.3s;">
                            </div>
                        </div>
                        <div style="font-size: 12px; color: var(--tg-theme-hint-color, #6c757d); margin-top: 4px;">
                            –Ø–¥–µ—Ä: {{serverStatus.server.details.cpu.cores}}
                        </div>
                    </div>
                    {{/if}}
                    {{#if serverStatus.server.details.disk}}
                    <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(0,0,0,0.1);">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span>üíø –î–∏—Å–∫:</span>
                            <span style="font-weight: 600;">{{serverStatus.server.details.disk.free}} —Å–≤–æ–±–æ–¥–Ω–æ /
                                {{serverStatus.server.details.disk.total}}</span>
                        </div>
                        <div style="background: rgba(0,0,0,0.1); border-radius: 8px; height: 8px; overflow: hidden;">
                            <div
                                style="background: linear-gradient(90deg, #8b5cf6, #7c3aed); height: 100%; width: {{serverStatus.server.details.disk.usagePercent}}%; transition: width 0.3s;">
                            </div>
                        </div>
                        <div style="font-size: 12px; color: var(--tg-theme-hint-color, #6c757d); margin-top: 4px;">
                            –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ: {{serverStatus.server.details.disk.used}}
                        </div>
                    </div>
                    {{/if}}
                    {{#if serverStatus.server.details.uptime}}
                    <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(0,0,0,0.1);">
                        <span>‚è±Ô∏è –í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã: {{serverStatus.server.details.uptime}}</span>
                    </div>
                    {{/if}}
                </div>
            </div>
            {{/if}}
        </div>
        {{/if}}

        {{#if isAdmin}}
        <div id="phrases-tab" class="tab-content">
            <div class="form-group">
                <input type="text" id="new-phrase" class="form-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—É—é —Ñ—Ä–∞–∑—É"
                    onfocus="handleInputFocus()">
                <button class="btn btn-primary" onclick="addPhrase()"
                    style="width: 100%; margin-top: 10px;">–î–æ–±–∞–≤–∏—Ç—å</button>
            </div>

            <div id="phrases-list">
                {{#if phrases}}
                {{#each phrases}}
                <div class="phrase-item" onclick="handlePhraseItemClick(event, {{this.id}})">
                    <div class="phrase-text">{{this.text}}</div>
                    <button class="btn btn-danger"
                        onclick="deletePhrase({{this.id}}); event.stopPropagation();">–£–¥–∞–ª–∏—Ç—å</button>
                </div>
                {{/each}}
                {{else}}
                <div class="empty-state">–°–ø–∏—Å–æ–∫ —Ñ—Ä–∞–∑ –ø—É—Å—Ç</div>
                {{/if}}
            </div>
        </div>
        {{/if}}
    </div>

    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let initData = '';
        let tg = null;

        (function () {
            console.log('[WebApp] ========== –ü–û–õ–ù–ê–Ø –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ==========');
            console.log('[WebApp] URL:', window.location.href);
            console.log('[WebApp] Search:', window.location.search);
            console.log('[WebApp] Hash:', window.location.hash);

            tg = window.Telegram?.WebApp;

            if (tg) {
                console.log('[WebApp] ‚úÖ Telegram WebApp API –¥–æ—Å—Ç—É–ø–µ–Ω');
                console.log('[WebApp] ========== Telegram WebApp Object ==========');
                console.log('[WebApp] tg object:', tg);
                console.log('[WebApp] tg.initData:', tg.initData ? `‚úÖ present (${tg.initData.length} chars)` : '‚ùå missing');
                if (tg.initData) {
                    console.log('[WebApp] initData full:', tg.initData);
                    console.log('[WebApp] initData preview:', tg.initData.substring(0, 200) + '...');
                }
                console.log('[WebApp] tg.version:', tg.version);
                console.log('[WebApp] tg.platform:', tg.platform);
                console.log('[WebApp] tg.initDataUnsafe:', tg.initDataUnsafe);
                console.log('[WebApp] tg.readyState:', tg.readyState);
                console.log('[WebApp] tg.colorScheme:', tg.colorScheme);
                console.log('[WebApp] tg.themeParams:', tg.themeParams);

                // –ü—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –≤—Å–µ —Å–≤–æ–π—Å—Ç–≤–∞ –æ–±—ä–µ–∫—Ç–∞
                console.log('[WebApp] ========== –í—Å–µ —Å–≤–æ–π—Å—Ç–≤–∞ tg –æ–±—ä–µ–∫—Ç–∞ ==========');
                for (const key in tg) {
                    try {
                        const value = tg[key];
                        if (typeof value === 'string' && value.length > 200) {
                            console.log(`[WebApp]   ${key}: ${value.substring(0, 200)}... (${value.length} chars)`);
                        } else {
                            console.log(`[WebApp]   ${key}:`, value);
                        }
                    } catch (e) {
                        console.log(`[WebApp]   ${key}: [–Ω–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å]`);
                    }
                }

                tg.ready();
                tg.expand();
            } else {
                console.error('[WebApp] ‚ùå Telegram WebApp API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
                console.error('[WebApp] window.Telegram:', window.Telegram);
                console.error('[WebApp] window.Telegram?.WebApp:', window.Telegram?.WebApp);
                console.error('[WebApp] –í–æ–∑–º–æ–∂–Ω–æ, –æ—Ç–∫—Ä—ã—Ç–æ –Ω–µ —á–µ—Ä–µ–∑ Telegram –∏–ª–∏ —Å–∫—Ä–∏–ø—Ç –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è');
            }

            // –ü–æ–ª—É—á–∞–µ–º initData –∏–∑ Telegram Web App
            const urlParams = new URLSearchParams(window.location.search);
            const initDataFromUrl = urlParams.get('initData') || '';

            console.log('[WebApp] ========== –ü–†–û–í–ï–†–ö–ê initData ==========');
            console.log('[WebApp] URL:', window.location.href);
            console.log('[WebApp] Query params:', window.location.search);

            // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: initData –∏–∑ Telegram API
            if (tg && tg.initData) {
                console.log('[WebApp] ‚úÖ –ü–æ–ª—É—á–µ–Ω initData –∏–∑ Telegram WebApp API');
                console.log('[WebApp] initData –¥–ª–∏–Ω–∞:', tg.initData.length);
                initData = tg.initData;

                // –ï—Å–ª–∏ initData –µ—Å—Ç—å –≤ API, –Ω–æ –Ω–µ—Ç –≤ URL - –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä
                if (!initDataFromUrl) {
                    console.log('[WebApp] –û—Ç–ø—Ä–∞–≤–ª—è–µ–º initData –Ω–∞ —Å–µ—Ä–≤–µ—Ä –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏...');

                    // –°–∫—Ä—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ, –µ—Å–ª–∏ –æ–Ω–æ –µ—Å—Ç—å (–ø–æ–∫–∞ –∏–¥–µ—Ç –≤–∞–ª–∏–¥–∞—Ü–∏—è)
                    const errorMsg = document.getElementById('error-message');
                    if (errorMsg) {
                        errorMsg.style.display = 'none';
                    }

                    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º initData –∫–∞–∫ –µ—Å—Ç—å, –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ JSON.stringify
                    // —Ç–∞–∫ –∫–∞–∫ initData —É–∂–µ —è–≤–ª—è–µ—Ç—Å—è —Å—Ç—Ä–æ–∫–æ–π
                    fetch('/webapp/init', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ initData: tg.initData }),
                    })
                        .then(response => {
                            console.log('[WebApp] –û—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞ –ø–æ–ª—É—á–µ–Ω, —Å—Ç–∞—Ç—É—Å:', response.status);
                            return response.json();
                        })
                        .then(data => {
                            console.log('[WebApp] –î–∞–Ω–Ω—ã–µ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', data);
                            if (data.success) {
                                console.log('[WebApp] ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞, –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É');
                                // –î–æ–±–∞–≤–ª—è–µ–º initData –≤ URL –∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º
                                urlParams.set('initData', encodeURIComponent(tg.initData));
                                window.location.href = window.location.pathname + '?' + urlParams.toString();
                            } else {
                                console.error('[WebApp] ‚ùå –í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–µ –ø—Ä–æ—à–ª–∞:', data.error);
                                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
                                const errorDiv = document.getElementById('error-message') || document.createElement('div');
                                errorDiv.id = 'error-message';
                                errorDiv.innerHTML = `
              <div style="padding: 20px; text-align: center;">
                <h2 style="color: #dc3545;">–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏</h2>
                <p>${data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è'}</p>
                <p style="margin-top: 20px; font-size: 14px; color: var(--tg-theme-hint-color, #666);">
                  –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—ã –æ—Ç–∫—Ä—ã–ª–∏ Web App —á–µ—Ä–µ–∑ Telegram –±–æ—Ç–∞
                </p>
              </div>
            `;
                                if (!errorDiv.parentNode) {
                                    document.body.insertBefore(errorDiv, document.body.firstChild);
                                }
                                errorDiv.style.display = 'block';
                            }
                        })
                        .catch(error => {
                            console.error('[WebApp] –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ initData:', error);
                            const errorDiv = document.getElementById('error-message') || document.createElement('div');
                            errorDiv.id = 'error-message';
                            errorDiv.innerHTML = `
            <div style="padding: 20px; text-align: center;">
              <h2 style="color: #dc3545;">–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è</h2>
              <p>–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä: ${error.message}</p>
            </div>
          `;
                            if (!errorDiv.parentNode) {
                                document.body.insertBefore(errorDiv, document.body.firstChild);
                            }
                            errorDiv.style.display = 'block';
                        });
                    // –ü—Ä–µ—Ä—ã–≤–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ, –∂–¥–µ–º –æ—Ç–≤–µ—Ç–∞ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞
                    return;
                } else {
                    // initData —É–∂–µ –≤ URL, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ
                    console.log('[WebApp] ‚úÖ initData —É–∂–µ –µ—Å—Ç—å –≤ URL');
                    try {
                        initData = decodeURIComponent(initDataFromUrl);
                    } catch (e) {
                        console.error('[WebApp] –û—à–∏–±–∫–∞ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è:', e);
                        initData = tg.initData;
                    }
                }
            } else if (initDataFromUrl) {
                // initData –≤ URL, –Ω–æ –Ω–µ—Ç –≤ API (–≤–æ–∑–º–æ–∂–Ω–æ, —É–∂–µ –±—ã–ª –¥–æ–±–∞–≤–ª–µ–Ω —Ä–∞–Ω–µ–µ)
                console.log('[WebApp] ‚ö†Ô∏è initData —Ç–æ–ª—å–∫–æ –≤ URL');
                try {
                    initData = decodeURIComponent(initDataFromUrl);
                } catch (e) {
                    console.error('[WebApp] –û—à–∏–±–∫–∞ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è:', e);
                }
            } else {
                console.error('[WebApp] ‚ùå initData –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤–µ–∑–¥–µ!');
                console.error('[WebApp] Telegram WebApp API:', tg ? '–¥–æ—Å—Ç—É–ø–µ–Ω' : '–Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
                console.error('[WebApp] tg.initData:', tg?.initData ? 'present' : 'missing');
                console.error('[WebApp] –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —Å–∫—Ä–∏–ø—Ç https://telegram.org/js/telegram-web-app.js –∑–∞–≥—Ä—É–∂–µ–Ω');

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
                if (!tg) {
                    document.body.innerHTML = `
          <div style="padding: 20px; text-align: center;">
            <h2 style="color: #dc3545;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ Telegram WebApp</h2>
            <p>–°–∫—Ä–∏–ø—Ç Telegram WebApp –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è</p>
            <p style="margin-top: 20px; font-size: 14px; color: #666;">
              –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—ã –æ—Ç–∫—Ä—ã–ª–∏ Web App —á–µ—Ä–µ–∑ Telegram –±–æ—Ç–∞, –∞ –Ω–µ –≤ –æ–±—ã—á–Ω–æ–º –±—Ä–∞—É–∑–µ—Ä–µ
            </p>
          </div>
        `;
                }
            }

            if (!initData) {
                console.error('[WebApp] ‚ùå initData –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç! Web App –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç–∫—Ä—ã—Ç —á–µ—Ä–µ–∑ Telegram –±–æ—Ç–∞.');
            } else {
                console.log('[WebApp] ‚úÖ initData –ø–æ–ª—É—á–µ–Ω, –¥–ª–∏–Ω–∞:', initData.length);
            }
        })(); // –ö–æ–Ω–µ—Ü IIFE

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ —Å –≤–∏–±—Ä–∞—Ü–∏–µ–π
        function handleStatusCardClick(card) {
            // –í–∏–±—Ä–∞—Ü–∏—è –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫—É
            if (tg && tg.HapticFeedback) {
                try {
                    tg.HapticFeedback.impactOccurred('light');
                } catch (e) {
                    console.log('[handleStatusCardClick] –í–∏–±—Ä–∞—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞:', e);
                }
            }
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫—É —Ñ—Ä–∞–∑—ã —Å –≤–∏–±—Ä–∞—Ü–∏–µ–π
        function handlePhraseItemClick(event, phraseId) {
            // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –∫–ª–∏–∫, –µ—Å–ª–∏ –∫–ª–∏–∫–Ω—É–ª–∏ –Ω–∞ –∫–Ω–æ–ø–∫—É —É–¥–∞–ª–µ–Ω–∏—è
            if (event.target.closest('.btn')) {
                return;
            }

            // –õ–µ–≥–∫–∞—è –≤–∏–±—Ä–∞—Ü–∏—è –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫—É —Ñ—Ä–∞–∑—ã
            if (tg && tg.HapticFeedback) {
                try {
                    tg.HapticFeedback.impactOccurred('light');
                } catch (e) {
                    console.log('[handlePhraseItemClick] –í–∏–±—Ä–∞—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞:', e);
                }
            }
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ñ–æ–∫—É—Å–∞ –Ω–∞ input —Å –≤–∏–±—Ä–∞—Ü–∏–µ–π
        function handleInputFocus() {
            // –õ–µ–≥–∫–∞—è –≤–∏–±—Ä–∞—Ü–∏—è –ø—Ä–∏ —Ñ–æ–∫—É—Å–µ –Ω–∞ input
            if (tg && tg.HapticFeedback) {
                try {
                    tg.HapticFeedback.impactOccurred('light');
                } catch (e) {
                    console.log('[handleInputFocus] –í–∏–±—Ä–∞—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞:', e);
                }
            }
        }

        function switchTab(tabName) {
            // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â—É—é –∞–∫—Ç–∏–≤–Ω—É—é –≤–∫–ª–∞–¥–∫—É
            const currentActiveTab = document.querySelector('.tab-content.active');
            const newTab = document.getElementById(tabName + '-tab');
            const currentTabId = currentActiveTab ? currentActiveTab.id : null;
            const newTabId = newTab ? newTab.id : null;

            // –ï—Å–ª–∏ —É–∂–µ –Ω–∞ —ç—Ç–æ–π –≤–∫–ª–∞–¥–∫–µ - —Ç—Ä—è—Å–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É
            if (currentTabId === newTabId) {
                // –õ–µ–≥–∫–∞—è –≤–∏–±—Ä–∞—Ü–∏—è
                if (tg && tg.HapticFeedback) {
                    try {
                        tg.HapticFeedback.impactOccurred('light');
                    } catch (e) {
                        console.log('[switchTab] –í–∏–±—Ä–∞—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞:', e);
                    }
                }

                // –ê–Ω–∏–º–∞—Ü–∏—è —Ç—Ä—è—Å–∫–∏
                if (currentActiveTab) {
                    currentActiveTab.classList.add('shaking');
                    setTimeout(() => {
                        currentActiveTab.classList.remove('shaking');
                    }, 500);
                }
                return;
            }

            // –í–∏–±—Ä–∞—Ü–∏—è –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –≤–∫–ª–∞–¥–æ–∫ (—É—Å–∏–ª–µ–Ω–Ω–∞—è)
            if (tg && tg.HapticFeedback) {
                try {
                    tg.HapticFeedback.impactOccurred('heavy');
                } catch (e) {
                    console.log('[switchTab] –í–∏–±—Ä–∞—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞:', e);
                }
            }

            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–Ω–∏–º–∞—Ü–∏–∏
            const currentIndex = currentActiveTab ? Array.from(document.querySelectorAll('.tab-content')).indexOf(currentActiveTab) : 0;
            const newIndex = Array.from(document.querySelectorAll('.tab-content')).indexOf(newTab);
            const direction = newIndex > currentIndex ? 1 : -1;

            // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –∫–ª–∞—Å—Å—ã
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active', 'animating');
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º inline —Å—Ç–∏–ª–∏
                content.style.transform = '';
                content.style.opacity = '';
            });

            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É –≤–∫–ª–∞–¥–∫–∏ —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π
            let activeTabButton = null;
            if (event && event.target) {
                activeTabButton = event.target;
            } else {
                // –ï—Å–ª–∏ –≤—ã–∑–≤–∞–Ω–æ –ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ
                const tabs = document.querySelectorAll('.tab');
                tabs.forEach(tab => {
                    if (tab.textContent.includes(tabName === 'status' ? '–°—Ç–∞—Ç—É—Å' : '–§—Ä–∞–∑—ã')) {
                        activeTabButton = tab;
                    }
                });
            }

            if (activeTabButton) {
                activeTabButton.classList.add('active');
            }

            // –û–±–Ω–æ–≤–ª—è–µ–º –∫–ª–∞—Å—Å –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—è
            const tabsContainer = document.querySelector('.tabs');
            if (tabsContainer) {
                if (tabName === 'phrases') {
                    tabsContainer.classList.add('tab-phrases-active');
                } else {
                    tabsContainer.classList.remove('tab-phrases-active');
                }
            }

            // –ü—Ä–∏–º–µ–Ω—è–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –∫ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ
            newTab.style.transform = `translateX(${direction * 20}px)`;
            newTab.style.opacity = '0';
            newTab.classList.add('active', 'animating');

            // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é
            requestAnimationFrame(() => {
                newTab.style.transform = 'translateX(0)';
                newTab.style.opacity = '1';

                // –£–±–∏—Ä–∞–µ–º –∫–ª–∞—Å—Å –∞–Ω–∏–º–∞—Ü–∏–∏ –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
                setTimeout(() => {
                    newTab.classList.remove('animating');
                }, 300);
            });

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –≤–∫–ª–∞–¥–∫—É –≤ localStorage
            try {
                localStorage.setItem('webapp_active_tab', tabName);
            } catch (e) {
                console.log('[switchTab] –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤–∫–ª–∞–¥–∫—É:', e);
            }
        }

        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –≤–∫–ª–∞–¥–∫—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        (function restoreActiveTab() {
            try {
                const savedTab = localStorage.getItem('webapp_active_tab');
                const currentActiveTab = document.querySelector('.tab-content.active');
                const currentActiveTabId = currentActiveTab ? currentActiveTab.id : null;

                // –û–±–Ω–æ–≤–ª—è–µ–º –∫–ª–∞—Å—Å –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—è –¥–ª—è —Ç–µ–∫—É—â–µ–π –∞–∫—Ç–∏–≤–Ω–æ–π –≤–∫–ª–∞–¥–∫–∏
                const tabsContainer = document.querySelector('.tabs');
                if (tabsContainer && currentActiveTabId) {
                    if (currentActiveTabId === 'phrases-tab') {
                        tabsContainer.classList.add('tab-phrases-active');
                    } else {
                        tabsContainer.classList.remove('tab-phrases-active');
                    }
                }

                // –ï—Å–ª–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–∞—è –≤–∫–ª–∞–¥–∫–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –æ—Ç —Ç–µ–∫—É—â–µ–π
                if (savedTab && (savedTab === 'status' || savedTab === 'phrases')) {
                    const savedTabId = savedTab + '-tab';

                    // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–∞—è –≤–∫–ª–∞–¥–∫–∞ –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –æ—Ç —Ç–µ–∫—É—â–µ–π
                    if (savedTabId !== currentActiveTabId) {
                        const tabElement = document.getElementById(savedTabId);
                        if (tabElement) {
                            // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞, —á—Ç–æ–±—ã —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ DOM –≥–æ—Ç–æ–≤
                            setTimeout(() => {
                                switchTab(savedTab);
                            }, 100);
                        }
                    }
                }
            } catch (e) {
                console.log('[restoreActiveTab] –ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤–∫–ª–∞–¥–∫—É:', e);
            }
        })();


        async function addPhrase() {
            // –í–∏–±—Ä–∞—Ü–∏—è –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ (—É—Å–∏–ª–µ–Ω–Ω–∞—è)
            if (tg && tg.HapticFeedback) {
                try {
                    tg.HapticFeedback.impactOccurred('heavy');
                } catch (e) {
                    console.log('[addPhrase] –í–∏–±—Ä–∞—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞:', e);
                }
            }

            const input = document.getElementById('new-phrase');
            const text = input.value.trim();

            if (!text) {
                if (tg && tg.showAlert) {
                    tg.showAlert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Ñ—Ä–∞–∑—ã');
                } else {
                    alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Ñ—Ä–∞–∑—ã');
                }
                return;
            }

            if (!initData) {
                console.error('[addPhrase] initData –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç!');
                if (tg && tg.showAlert) {
                    tg.showAlert('–û—à–∏–±–∫–∞: –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
                } else {
                    alert('–û—à–∏–±–∫–∞: –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
                }
                return;
            }

            const urlParams = new URLSearchParams();
            urlParams.set('initData', encodeURIComponent(initData));

            console.log('[addPhrase] –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞:', { text, initDataLength: initData.length });

            try {
                const response = await fetch(`/webapp/api/phrases?${urlParams.toString()}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text }),
                });

                console.log('[addPhrase] –û—Ç–≤–µ—Ç –ø–æ–ª—É—á–µ–Ω:', response.status, response.statusText);

                const responseData = await response.json();
                console.log('[addPhrase] –î–∞–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç–∞:', responseData);

                if (response.ok) {
                    input.value = '';
                    await loadPhrases();

                    // –í–∏–±—Ä–∞—Ü–∏—è —É—Å–ø–µ—Ö–∞
                    if (tg && tg.HapticFeedback) {
                        try {
                            tg.HapticFeedback.notificationOccurred('success');
                        } catch (e) {
                            console.log('[addPhrase] –í–∏–±—Ä–∞—Ü–∏—è —É—Å–ø–µ—Ö–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞:', e);
                        }
                    }

                    if (tg && tg.showAlert) {
                        tg.showAlert('–§—Ä–∞–∑–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞');
                    } else {
                        alert('–§—Ä–∞–∑–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞');
                    }

                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –≤–∫–ª–∞–¥–∫—É, —á—Ç–æ–±—ã –æ—Å—Ç–∞—Ç—å—Å—è –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ —Ñ—Ä–∞–∑
                    try {
                        localStorage.setItem('webapp_active_tab', 'phrases');
                    } catch (e) {
                        console.log('[addPhrase] –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤–∫–ª–∞–¥–∫—É:', e);
                    }
                } else {
                    const errorMsg = responseData.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Ñ—Ä–∞–∑—ã';
                    console.error('[addPhrase] –û—à–∏–±–∫–∞:', errorMsg);

                    // –í–∏–±—Ä–∞—Ü–∏—è –æ—à–∏–±–∫–∏
                    if (tg && tg.HapticFeedback) {
                        try {
                            tg.HapticFeedback.notificationOccurred('error');
                        } catch (e) {
                            console.log('[addPhrase] –í–∏–±—Ä–∞—Ü–∏—è –æ—à–∏–±–∫–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞:', e);
                        }
                    }

                    if (tg && tg.showAlert) {
                        tg.showAlert('–û—à–∏–±–∫–∞: ' + errorMsg);
                    } else {
                        alert('–û—à–∏–±–∫–∞: ' + errorMsg);
                    }
                }
            } catch (error) {
                console.error('[addPhrase] –ò—Å–∫–ª—é—á–µ–Ω–∏–µ:', error);

                // –í–∏–±—Ä–∞—Ü–∏—è –æ—à–∏–±–∫–∏
                if (tg && tg.HapticFeedback) {
                    try {
                        tg.HapticFeedback.notificationOccurred('error');
                    } catch (e) {
                        console.log('[addPhrase] –í–∏–±—Ä–∞—Ü–∏—è –æ—à–∏–±–∫–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞:', e);
                    }
                }

                if (tg && tg.showAlert) {
                    tg.showAlert('–û—à–∏–±–∫–∞: ' + error.message);
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + error.message);
                }
            }
        }

        async function deletePhrase(id) {
            // –í–∏–±—Ä–∞—Ü–∏—è –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ (—É—Å–∏–ª–µ–Ω–Ω–∞—è)
            if (tg && tg.HapticFeedback) {
                try {
                    tg.HapticFeedback.impactOccurred('heavy');
                } catch (e) {
                    console.log('[deletePhrase] –í–∏–±—Ä–∞—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞:', e);
                }
            }

            const confirmMessage = '–£–¥–∞–ª–∏—Ç—å —ç—Ç—É —Ñ—Ä–∞–∑—É?';

            if (tg && tg.showConfirm) {
                tg.showConfirm(confirmMessage, async (confirmed) => {
                    if (!confirmed) return;
                    await performDelete(id);
                });
            } else {
                if (confirm(confirmMessage)) {
                    await performDelete(id);
                }
            }
        }

        async function performDelete(id) {
            const urlParams = new URLSearchParams();
            if (initData) urlParams.set('initData', encodeURIComponent(initData));

            try {
                const response = await fetch(`/webapp/api/phrases/${id}?${urlParams.toString()}`, {
                    method: 'DELETE',
                });

                if (response.ok) {
                    await loadPhrases();

                    // –í–∏–±—Ä–∞—Ü–∏—è —É—Å–ø–µ—Ö–∞
                    if (tg && tg.HapticFeedback) {
                        try {
                            tg.HapticFeedback.notificationOccurred('success');
                        } catch (e) {
                            console.log('[performDelete] –í–∏–±—Ä–∞—Ü–∏—è —É—Å–ø–µ—Ö–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞:', e);
                        }
                    }

                    if (tg && tg.showAlert) {
                        tg.showAlert('–§—Ä–∞–∑–∞ —É–¥–∞–ª–µ–Ω–∞');
                    } else {
                        alert('–§—Ä–∞–∑–∞ —É–¥–∞–ª–µ–Ω–∞');
                    }
                } else {
                    // –í–∏–±—Ä–∞—Ü–∏—è –æ—à–∏–±–∫–∏
                    if (tg && tg.HapticFeedback) {
                        try {
                            tg.HapticFeedback.notificationOccurred('error');
                        } catch (e) {
                            console.log('[performDelete] –í–∏–±—Ä–∞—Ü–∏—è –æ—à–∏–±–∫–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞:', e);
                        }
                    }

                    if (tg && tg.showAlert) {
                        tg.showAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ñ—Ä–∞–∑—ã');
                    } else {
                        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ñ—Ä–∞–∑—ã');
                    }
                }
            } catch (error) {
                // –í–∏–±—Ä–∞—Ü–∏—è –æ—à–∏–±–∫–∏
                if (tg && tg.HapticFeedback) {
                    try {
                        tg.HapticFeedback.notificationOccurred('error');
                    } catch (e) {
                        console.log('[performDelete] –í–∏–±—Ä–∞—Ü–∏—è –æ—à–∏–±–∫–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞:', e);
                    }
                }

                if (tg && tg.showAlert) {
                    tg.showAlert('–û—à–∏–±–∫–∞: ' + error.message);
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + error.message);
                }
            }
        }

        async function loadPhrases() {
            const urlParams = new URLSearchParams();
            if (initData) urlParams.set('initData', initData);

            try {
                const response = await fetch(`/webapp/api/phrases?${urlParams.toString()}`);
                const phrases = await response.json();

                const list = document.getElementById('phrases-list');
                if (phrases.length === 0) {
                    list.innerHTML = '<div class="empty-state">–°–ø–∏—Å–æ–∫ —Ñ—Ä–∞–∑ –ø—É—Å—Ç</div>';
                } else {
                    list.innerHTML = phrases.map(p => `
            <div class="phrase-item" onclick="handlePhraseItemClick(event, ${p.id})">
              <div class="phrase-text">${p.text}</div>
              <button class="btn btn-danger" onclick="deletePhrase(${p.id}); event.stopPropagation();">–£–¥–∞–ª–∏—Ç—å</button>
            </div>
          `).join('');
                }
            } catch (error) {
                console.error('Error loading phrases:', error);
            }
        }

        // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
        setInterval(async () => {
            const urlParams = new URLSearchParams();
            if (initData) urlParams.set('initData', initData);

            try {
                const response = await fetch(`/webapp/api/status?${urlParams.toString()}`);
                const status = await response.json();
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
                location.reload();
            } catch (error) {
                console.error('Error refreshing status:', error);
            }
        }, 30000);
    </script>
</body>

</html>